---
title: "historical_cod_data"
author: "Becca Van Hoeck"
date: "3/9/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Loading packages

```{r}
library(ggplot2)
library(dplyr)
library(lubridate)
library(MASS)
library(lunar)
library(tidyr)
```

## Test R code to load detections

```{r}
#sels_1308 = list.files(path = "C:/Users/Becca/Documents/MATLAB/ISRAT_Projects/BRP_MA-RI_201308/raven_format/validated", 
#            pattern = "^[Ch9_RVH]$")
# 
# sels_1308 = list.files(path = "C:/Users/Becca/Documents/MATLAB/ISRAT_Projects/BRP_MA-RI_201308/raven_format/validated", 
#            pattern = "[m]")


```

## Load Data

```{r}
cod = read.csv('data/cod_calls_04-5-21.csv', header = TRUE)

# remove any data not from channel 9
cod[cod$Channel != 9,] = NA
cod = na.omit(cod)

# paste date and time into a single lubridate datetime
cod$DateTime = paste(cod$BeginDate, cod$BeginClockTime, sep = " ") 
cod$DateTime = ymd_hms(cod$DateTime, tz = "EST") 

#assign spawning season
cod$SpawnSeason = case_when(
  year(cod$DateTime) == 2013 ~ "H_YR1", 
  year(cod$DateTime) == 2014 & month(cod$DateTime) == 1 | month(cod$DateTime) == 2 ~ "H_YR1",
  year(cod$DateTime) == 2014 & month(cod$DateTime) == 11 | month(cod$DateTime) == 12 ~ "H_YR2",
  year(cod$DateTime) == 2015 ~ "H_YR2")

```

## Seasonal Patterns

```{r}
gruntperday = cod %>% 
  group_by(SpawnSeason, date = date(cod$DateTime)) %>%
  summarise(n_grunts = n())

gruntperday$month = month(gruntperday$date)
gruntperday$month = factor(gruntperday$month, levels = c("11","12","1"))

gruntperday$day = day(gruntperday$date)
#gruntperday$monthday = paste(gruntperday$month,gruntperday$day, sep = "_")

# remove non spawning season grunt
gruntperday = gruntperday[-1,]

#confirm each spawning season has average >5 grunts per day
confirm_ss = gruntperday %>% 
  group_by(SpawnSeason, month(date)) %>% 
  summarise(mean_call = mean(n_grunts))

ggplot(data = gruntperday, aes(x = day, y = n_grunts))+ theme_bw()+
  geom_col()+
  facet_grid(rows = vars(SpawnSeason), cols = vars(month))+
  xlab("Day of the Month")+ ylab("Observed number of grunts")+
  ggtitle("Seasonal Patterns in Sound Production")+
  theme(axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        title = element_text(size = 14), 
        strip.text = element_text(size = 12))

```

# Exploring daily patterns

```{r}
gruntperhr = cod %>%
  group_by(SpawnSeason = cod$SpawnSeason, year = year(cod$DateTime), month = month(cod$DateTime), date = date(cod$DateTime),
           hour = hour(cod$DateTime)) %>%
  summarise(n_grunts = n()) %>%
  group_by(SpawnSeason, year, month, hour) %>%
  summarise(avg_hr = mean(n_grunts), stdev = sd(n_grunts))


gruntperhrfilt = gruntperhr[-1,]
gruntperhrfilt$month = factor(gruntperhrfilt$month, levels = c("11","12","1"))
levels(gruntperhrfilt$month) = c("11",'12','1')

ggplot(data = gruntperhrfilt, aes(x = hour, y = avg_hr))+ theme_bw()+
  geom_col()+
  geom_errorbar(aes(ymin = avg_hr, ymax = avg_hr+stdev, width = 0.2))+
  facet_grid(rows = vars(SpawnSeason), cols = vars(month))+
  xlab("Hour of the the day")+ ylab("Average number of grunts per hour")+
  ggtitle("Daily Patterns in Sound Production")+
  theme(axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        title = element_text(size = 14), 
        strip.text = element_text(size = 12))
```

## Load env data

```{r}
temp_2013 = read.csv("data/buoy_data_2013.csv", header = TRUE)
temp_2014 = read.csv("data/buoy_data_2014.csv", header = TRUE)
temp_2015 = read.csv("data/buoy_data_2015.csv", header = TRUE)
temp_2019 = read.csv("data/buoy_data_2019.csv", header = TRUE)

```

# Assemble dataframe for model

```{r}
DateTime1 = seq(ymd_hm("2013-11-01 00:00"), ymd_hm("2014-01-31 23:00"), by = "hour")
DateTime = as.data.frame(DateTime1)
colnames(DateTime) = "DateTime"
DateTime2 = seq(ymd_hm("2014-11-01 00:00"), ymd_hm("2015-01-31 23:00"), by = "hour")
DateTime2 = as.data.frame(DateTime2)
colnames(DateTime2) ="DateTime"

DateTime = rbind(DateTime,DateTime2)
cod_data = as.data.frame(DateTime)

# cod hourly grunt rate
hourly_presence = cod %>%
  group_by(Month = month(cod$DateTime), date = date(cod$DateTime), hour = hour(cod$DateTime)) %>%
  summarise(n_grunts = n())
hourly_presence$DateTime = ymd_h(paste(hourly_presence$date, hourly_presence$hour))

# cod hourly grunt presence
cod_data = left_join(cod_data,hourly_presence[,c(4,5)], by = "DateTime")
cod_data$n_grunts[is.na(cod_data$n_grunts)] = 0
cod_data$presence = cod_data$n_grunts
cod_data$presence[cod_data$presence >= 1] = 1
cod_data$presence[is.na(cod_data$presence)] = 0

# Natural cycles
cod_data$year = year(cod_data$DateTime)
cod_data$month = month(cod_data$DateTime)
cod_data$day = day(cod_data$DateTime)
cod_data$hour = hour(cod_data$DateTime)

# adding factor for spawning season
cod_data$SpawnSeason = case_when(
  year(cod_data$DateTime) == 2013 ~ "H_YR1", 
  year(cod_data$DateTime) == 2014 & month(cod_data$DateTime) == 1 | month(cod_data$DateTime) == 2 ~ "H_YR1",
  year(cod_data$DateTime) == 2014 & month(cod_data$DateTime) == 11 | month(cod_data$DateTime) == 12 ~ "H_YR2",
  year(cod_data$DateTime) == 2015 ~ "H_YR2")
cod_data$SpawnSeason = factor(cod_data$SpawnSeason)

# lunar data
cod_data$lunarphase = lunar.phase(cod_data$DateTime)
cod_data$lunarphaseName = lunar.phase(cod_data$DateTime, name = 4)

# temperature
#2013
temp_2013$DateTime = ymd_h(paste(temp_2013$YY,temp_2013$MM, temp_2013$DD, temp_2013$hh))
hour_temp13 = temp_2013 %>%
  group_by(DateTime) %>%
  summarize(avg_TempC = mean(WTMP_degC)) %>%
  filter(DateTime > "2013-11-01" & DateTime < "2013-12-31")

#2014
temp_2014$DateTime = ymd_h(paste(temp_2014$X.YY,temp_2014$MM, temp_2014$DD, temp_2014$hh))
hour_temp14 = temp_2014 %>%
  group_by(DateTime) %>%
  summarize(avg_TempC = mean(WTMP_degC)) %>%
  filter(DateTime > "2014-01-01" & DateTime < "2014-12-31")
colnames(temp_2014) = c("YY","MM","DD","hh","mm","WVHT_m","DPD_sec","APD_sec" ,"MWD_degT","WTMP_degC","DateTime")

#2015
temp_2015$DateTime = ymd_h(paste(temp_2015$X.YY,temp_2015$MM, temp_2015$DD, temp_2015$hh))
hour_temp15 = temp_2015 %>%
  group_by(DateTime) %>%
  summarize(avg_TempC = mean(WTMP_degC)) %>%
  filter(DateTime > "2015-01-01" & DateTime < "2015-12-31")
colnames(temp_2015) = c("YY","MM","DD","hh","mm","WVHT_m","DPD_sec","APD_sec" ,"MWD_degT","WTMP_degC","DateTime")

temp = rbind(hour_temp13,hour_temp14,hour_temp15)

cod_data = left_join(cod_data, temp, by = "DateTime")

```

## Explore patterns between predictors and call presence

```{r}

# plot Mean grunts per hour for each day across spawning season. Single plot for each spawning season
meanGruntHrDay = cod_data %>%
  group_by(SpawnSeason, month, day) %>%
  summarize(meanGrunt = mean(n_grunts))

meanGruntHrDay["month"][meanGruntHrDay["month"] == "1"] = 13
meanGruntHrDay$monthday = paste(meanGruntHrDay$month, meanGruntHrDay$day, sep = "_")

# average grunts per hour on each day
# modeled after Zemeckis et al (2019) Fig 6
# add model predictions to these also
ggplot(data = meanGruntHrDay, aes(x = monthday, y = meanGrunt))+ theme_bw()+
  geom_col()+
  scale_x_discrete(breaks = c("11_1","12_1","13_1"), 
                   labels = c("Nov", "Dec", "Jan"))+
  facet_grid(cols = vars(SpawnSeason))
  
#uses average calls per hour for each month, stacked bars represent each month/year combo
ggplot(data=gruntperhrfilt, aes(x=hour,y = avg_hr))+ theme_bw()+
  geom_col(fill='grey',color='black')+
  coord_polar()#+
  #scale_x_continuous("", limits = c(0, 24), 
  #                   breaks = seq(0, 24), labels = seq(0,24))#+
  #scale_y_continuous("",limits=c(-2,10))

# counts total number of calls observed at each hour across all months and years
ggplot(data=cod, aes(x=hour(DateTime)))+ theme_bw()+
  geom_histogram(fill='grey',color='black', breaks=c(1:24))+
  coord_polar()+
  scale_y_continuous(limits = c(-10,80))

ggplot(data=cod_data, aes(x=lunarphase,y = n_grunts))+ theme_bw()+
  geom_col(fill='grey',color='black')+
  coord_polar()#+


# early plots- not useful
ggplot(aes(x = lunarphase, y= presence), data = cod_data)+ theme_bw()+
  geom_jitter()

ggplot(aes(x = WTMP_degC, y= n_grunts), data = cod_data)+ theme_bw()+
  geom_jitter()

ggplot(aes(x = factor(month), y= n_grunts), data = cod_data)+ theme_bw()+
  geom_jitter()

ggplot(aes(x = factor(day), y= n_grunts), data = cod_data)+ theme_bw()+
  geom_jitter()

ggplot(aes(x = DateTime, y = n_grunts), data = cod_data)+theme_bw()+
  geom_col()
  
ggplot(aes(x = DateTime, y = presence), data = cod_data)+theme_bw()+
  geom_col()+ facet_grid(rows = cod_data$SpawnSeason)


```

# Model cod vocalization rate
Build this off of Micah's analysis
Actually, use a hurdle model to simultaneously model the binomial presence absence and the rate when present   

```{r}
# probably want this in radians, not factor
simpleMod = lm(n_grunts ~ lunarphaseName, data = cod_data)
ggplot(simpleMod, aes(x = lunarphaseName, y = n_grunts))+ 
  geom_point()+
  geom_line(aes(y = .fitted))
simpleMod = lm(n_grunts ~ lunarphase, data = cod_data)
ggplot(simpleMod, aes(x = lunarphase, y = n_grunts))+ 
  geom_point()+
  geom_line(aes(y = .fitted))

plot(simpleMod)


# Try modeling the presence and rate separately first to understand each one, then can use hurdle model

codMod1 = glm(presence ~  sin(hour) + cos(hour) + sin(lunarphase)+ cos(lunarphase) + year + WTMP_degC, 
               data = cod_data, binomial(link = "logit"))
summary(codMod1) # hour is not actually significant at alpha = 0.05
drop1(codMod1) # removing hour doesn't change AIC in a distinguishable way

codMod2 = glm(presence ~  sin(hour) + cos(hour) + sin(lunarphase)+ cos(lunarphase) + SpawnSeason + WTMP_degC, 
               data = cod_data, binomial(link = "logit")) 
summary(codMod2)

codMod3 = glm(presence ~  sin(lunarphase)+ cos(lunarphase) + year + WTMP_degC, 
               data = cod_data, binomial(link = "logit")) 
summary(codMod3)

codMod4 = glm(presence ~  sin(lunarphase)+ cos(lunarphase) + SpawnSeason + WTMP_degC, 
               data = cod_data, binomial(link = "logit")) 
summary(codMod4)

AIC(codMod1, codMod2, codMod3, codMod4)

# Rate Model
library(gamlss)
RateMod1 = glm(n_grunts ~ sin(hour) + cos(hour) + sin(lunarphase)+ cos(lunarphase) + year + WTMP_degC, 
               data = cod_data, poisson(link = "log"))
summary(RateMod1)
drop1(RateMod1)

RateModNB = glm.nb(n_grunts ~ sin(hour) + cos(hour) + sin(lunarphase)+ cos(lunarphase) + year, 
               data = cod_data)
summary(RateModNB)

# why remove nas in this package only?
RateModNBII = gamlss(n_grunts ~ sin(hour) + cos(hour) + sin(lunarphase)+ cos(lunarphase) + year, 
               data = na.omit(cod_data), family = NBII)

AIC(RateMod1, RateModNB,RateModNBII)

library(pscl)

#trim to bounds of spawning season
cod_data = cod_data %>% 
  filter(DateTime > "2013-11-17")

cod_hurdle1 = hurdle(n_grunts ~ month + day + 
                       sin(hour) + cos(hour) + 
                       sin(lunarphase) + cos(lunarphase) + 
                       month:sin(lunarphase) + month:cos(lunarphase),
                     data = cod_data, dist = "poisson", zero.dist = "binomial")

summary(cod_hurdle1)


```


