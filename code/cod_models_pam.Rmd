---
title: "Rebecca Van Hoeck"
author: "Becca Van Hoeck"
date: "4/19/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(lunar)
library(dplyr)
library(tidyr)

```

## Script to build models and evaluate model fit to identify environmental drivers of atlantic cod vocalizations

Load data - all data wrangling and exploratory visualizations were done in historical_cod_data.RMD
```{r}

## Tidy data with grunt presence, rate, and associated environmental variables
# note that there are many times missing temperatures. Possibly not able to use this variable because grunt data is so sparse. I don't want to remove some cod data just to have complete cases with temperature
cod_data = read.csv("data/cod_data_05-26-21.csv")

# identify julian day
yearDay = yday(cod_data$DateTime)
yearWeek = week(cod_data$DateTime)

cod_data = cod_data %>%
  mutate(region = "CoxLedge", site = "COX01", siteY = paste(site,year, sep = "_"),
           julian = paste(year, yearDay, sep = "_"), week = paste(year, yearWeek, sep = "_"))
cod_data = cod_data[,-1] # remove row index

# Mass Bay Data
load('data/gsub.rdat')

gsub = gsub %>%
  mutate(region = "MassBay")

# Remake Mass Bay Dataset to match Cox Ledge Dataframe
MassBayCod = data.frame(gsub$Date)
colnames(MassBayCod) = "DateTime"
MassBayCod$n_grunts = gsub$GPH
MassBayCod$presence = case_when(gsub$GPH == 0 ~ 0,
                                gsub$GPH > 0 ~ 1)
MassBayCod$year = year(MassBayCod$Date)
MassBayCod$month = month(MassBayCod$Date)
MassBayCod$day = day(MassBayCod$Date)
MassBayCod$hour = gsub$H
MassBayCod$lunarphase = gsub$MOON
MassBayCod$lunar4 = gsub$MOON4
MassBayCod$lunar8 = gsub$MOON8
MassBayCod$SpawnSeason = (NaN);
MassBayCod$avg_TempC = (NaN);
MassBayCod$region = gsub$region
MassBayCod$site = gsub$Site
MassBayCod$siteY = gsub$SiteY
MassBayCod$julian = gsub$DAY
MassBayCod$week = gsub$WK

cod = rbind(cod_data, MassBayCod)

```

# Model cod vocalization presence
Build this off of Micah's analysis
Actually, use a hurdle model to simultaneously model the binomial presence absence and the rate when present   

```{r}
# Try modeling the presence and rate separately first to understand each one, then can use hurdle model
codMod1 = glm(presence ~  sin(hour) + cos(hour) + sin(lunarphase)+ cos(lunarphase) + SpawnSeason + avg_TempC, 
               data = cod_data, binomial(link = "logit")) 
summary(codMod1)
drop1(codMod1)

# remove diel cycle (hour)
codMod2 = glm(presence ~  sin(lunarphase)+ cos(lunarphase) + SpawnSeason + avg_TempC, 
               data = cod_data, binomial(link = "logit")) 
summary(codMod2)

# remove temperature
codMod3 = glm(presence ~  sin(lunarphase)+ cos(lunarphase) + SpawnSeason,
               data = cod_data, binomial(link = "logit")) 
summary(codMod3)

AIC(codMod1, codMod2, codMod3)

# remove missing data and add predictions to dataframe
cod_dataCC = na.omit(cod_data)
cod_dataCC$predicted = predict(codMod2)


plot(cod_dataCC$DateTime, cod_dataCC$predicted)
```

## Model Grunt Rate

```{r}
# Rate Model
library(gamlss)
# Full model - need to add semi-lunar cycle
RateMod1 = glm(n_grunts ~ sin(hour) + cos(hour) + sin(lunarphase)+ cos(lunarphase) + SpawnSeason + avg_TempC, 
               data = cod_data, poisson(link = "log"))
summary(RateMod1)
drop1(RateMod1)

# same model but negative binomial
RateModNB = glm.nb(n_grunts ~ sin(hour) + cos(hour) + sin(lunarphase)+ cos(lunarphase) + SpawnSeason + avg_TempC, 
               data = cod_data)
summary(RateModNB)

# same model, but quadratic error term on negative binomial
# why remove nas in this package only?
RateModNBII = gamlss(n_grunts ~ sin(hour) + cos(hour) + sin(lunarphase)+ cos(lunarphase) + SpawnSeason + avg_TempC, 
               data = na.omit(cod_data), family = NBII)
summary(RateModNBII)

AIC(RateMod1, RateModNB, RateModNBII, RateModNBII_2)

# Neg binomial with quadratic, but removed diel cycle. 
RateModNBII_2 = gamlss(n_grunts ~ sin(lunarphase)+ cos(lunarphase) + SpawnSeason + avg_TempC, 
               data = na.omit(cod_data), family = NBII)

AIC(RateModNBII, RateModNBII_2)

ratePredict = predict(RateModNBII)

plot(ratePredict)
```

## Hurdle model

```{r}
library(pscl)

# #trim to bounds of spawning season
# cod_data = cod_data %>% 
#   filter(DateTime > "2013-11-17")
# 
# cod_hurdle1 = hurdle(n_grunts ~ month + day + 
#                        sin(hour) + cos(hour) + 
#                        sin(lunarphase) + cos(lunarphase) + 
#                        month:sin(lunarphase) + month:cos(lunarphase),
#                      data = cod_data, dist = "poisson", zero.dist = "binomial")
# 
# summary(cod_hurdle1)




```

